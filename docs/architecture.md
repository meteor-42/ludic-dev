# Архитектура букмекерской платформы

## Текущая архитектура (MVP)

```
                         ТЕКУЩЕЕ СОСТОЯНИЕ
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    БРАУЗЕР                               │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │   │
│  │  │   Login     │  │  Dashboard  │  │  AuthContext    │  │   │
│  │  │   Page      │  │    Page     │  │  (JWT в памяти) │  │   │
│  │  └──────┬──────┘  └──────┬──────┘  └────────┬────────┘  │   │
│  │         │                │                   │           │   │
│  │         └────────────────┼───────────────────┘           │   │
│  │                          │                               │   │
│  │                   fetch(/api/...)                        │   │
│  └──────────────────────────┼───────────────────────────────┘   │
│                             │                                   │
│                             ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              EXPRESS BACKEND (server/routes.ts)           │  │
│  │                                                           │  │
│  │   /api/auth/login  → валидация → PocketBase.authWithPwd  │  │
│  │   /api/auth/me     → проверка токена → authRefresh       │  │
│  │   /api/auth/logout → очистка сессии                      │  │
│  │                                                           │  │
│  └──────────────────────────────┬────────────────────────────┘  │
│                                 │                               │
│                    REPLIT (один процесс)                        │
└─────────────────────────────────┼───────────────────────────────┘
                                  │
                                  ▼ HTTPS
                    ┌─────────────────────────┐
                    │      POCKETBASE         │
                    │    (внешний сервис)     │
                    │                         │
                    │  - users collection     │
                    │  - JWT токены           │
                    │  - хеширование паролей  │
                    └─────────────────────────┘
```

## Как идут запросы

### 1. Авторизация (Login)
```
Пользователь вводит email/пароль
        │
        ▼
React Form → валидация Zod
        │
        ▼
fetch POST /api/auth/login
        │
        ▼
Express получает запрос
        │
        ▼
Создаёт PocketBase клиент
        │
        ▼
PocketBase.authWithPassword(email, password)
        │
        ▼
PocketBase проверяет credentials
        │
        ▼
Возвращает JWT токен + user data
        │
        ▼
Express возвращает { token, user }
        │
        ▼
AuthContext сохраняет в localStorage
        │
        ▼
Redirect на Dashboard
```

### 2. Проверка токена (при обновлении страницы)
```
Страница загружается
        │
        ▼
AuthContext читает токен из localStorage
        │
        ▼
fetch GET /api/auth/me с Bearer токеном
        │
        ▼
Express проверяет через PocketBase.authRefresh()
        │
        ▼
Токен валиден? → Да → Показать Dashboard
                  │
                  └─→ Нет → Redirect на Login
```

## Роли компонентов

| Компонент | Роль | Где находится |
|-----------|------|---------------|
| **React/Vite** | UI, формы, роутинг, хранение токена | `client/` |
| **Express** | API прокси, валидация, безопасность | `server/routes.ts` |
| **PocketBase** | Хранение пользователей, JWT, auth | Внешний сервис |
| **PostgreSQL** | Данные ставок (будущее) | Replit DB |

## Целевая архитектура (масштабирование)

```
                         ЦЕЛЕВАЯ АРХИТЕКТУРА
┌──────────────────────────────────────────────────────────────────────┐
│                          API GATEWAY / LOAD BALANCER                  │
│                    (nginx / cloud LB / rate limiting)                │
└───────────────┬──────────────┬──────────────┬───────────────┬────────┘
                │              │              │               │
        ┌───────▼───────┐ ┌────▼────┐ ┌───────▼──────┐ ┌──────▼──────┐
        │ AUTH SERVICE  │ │ BETTING │ │ ODDS SERVICE │ │   WALLET    │
        │   (текущий)   │ │ SERVICE │ │              │ │   SERVICE   │
        │               │ │         │ │              │ │             │
        │ - login       │ │ - bets  │ │ - live odds  │ │ - deposit   │
        │ - register    │ │ - slips │ │ - events     │ │ - withdraw  │
        │ - verify      │ │ - settle│ │ - matches    │ │ - balance   │
        └───────┬───────┘ └────┬────┘ └───────┬──────┘ └──────┬──────┘
                │              │              │               │
        ┌───────▼───────┐ ┌────▼────────┐ ┌───▼───────┐ ┌─────▼──────┐
        │  POCKETBASE   │ │ POSTGRESQL  │ │   REDIS   │ │ POSTGRESQL │
        │  (users)      │ │ (bets,      │ │ (cache,   │ │ (wallets,  │
        │               │ │  history)   │ │  sessions)│ │  payments) │
        └───────────────┘ └─────────────┘ └───────────┘ └────────────┘
```

## Нужен ли Dashboard отдельным сервисом?

### Сейчас: НЕТ
- Dashboard тесно связан с авторизацией
- Один разработчик/команда
- Мало функционала
- Простое развёртывание

### Когда НУЖНО разделять:
- Разные команды работают над auth и dashboard
- Dashboard становится сложным (графики, аналитика, real-time)
- Нужны разные циклы релизов
- Высокая нагрузка требует отдельного масштабирования

## План масштабирования

### Фаза 1 (текущая) - MVP Auth
```
[React + Express] → [PocketBase]
```
Готово!

### Фаза 2 - Добавить PostgreSQL для ставок
```
[React + Express] → [PocketBase] (auth)
              └───→ [PostgreSQL] (bets, odds, wallet)
```
Задачи:
- Создать схему в `shared/schema.ts` для bets, odds, wallet
- Добавить Drizzle ORM миграции
- Новые API endpoints для ставок

### Фаза 3 - Микросервисы
```
[API Gateway]
     ├── [Auth Service] → [PocketBase]
     ├── [Betting Service] → [PostgreSQL]
     ├── [Odds Service] → [Redis + External API]
     └── [Wallet Service] → [PostgreSQL + Payment Gateway]
```
Задачи:
- Разделить на отдельные репозитории/сервисы
- Добавить API Gateway
- Настроить межсервисную коммуникацию (Kafka/NATS)

## Резюме

| Вопрос | Ответ |
|--------|-------|
| Где backend? | `server/routes.ts` - Express на том же порту 5000 |
| Где PocketBase? | Внешний сервис (URL в POCKETBASE_URL) |
| Где PostgreSQL? | Пока нет, добавим для данных ставок |
| Dashboard отдельно? | Пока не нужно, при масштабировании - да |
